<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Your Way</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ===================== DESKTOP ===================== */
        @media screen and (min-width: 769px) {
            body {
                flex-direction: row;
                overflow: hidden;
            }

            nav {
                background: linear-gradient(#50036a, #a147d8,#872ddc,purple);
                width: 22%;
                min-width: 240px;
                max-width: 300px;
                height: 100vh;
                padding: 30px 15px 0px 15px;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                overflow-y: auto;
                overflow-x: visible;
                flex-shrink: 0;
                position: relative;
                z-index: 500;
            }
            P{
                color: whitesmoke;
                text-align: center;
            }

            nav::-webkit-scrollbar {
                width: 4px;
            }

            nav::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
            }

            nav::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.3);
                border-radius: 4px;
            }

            .nav-container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                overflow: visible;
            }

            .title-container {
                text-align: left;
                margin-bottom: 25px;
                width: 100%;
            }

            .head1 {
                font-size: clamp(18px, 2.5vw, 30px);
                font-family: Georgia, 'Times New Roman', Times, serif;
                color: rgb(234, 222, 198);
                margin-bottom: 10px;
                margin-top: 0;
                white-space: nowrap;
            }

            .input-section {
                width: 100%;
                margin-top: 0;
                overflow: visible;
                position: relative;
                z-index: 501;
            }

            .input-row {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 0;
                width: 100%;
                position: relative;
                overflow: visible;
            }

            .input-wrapper {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 0;
                position: relative;
                overflow: visible;
            }

            .input-wrapper:first-of-type {
                z-index: 502;
            }

            .input-wrapper:last-of-type {
                z-index: 501;
            }

            #to-area {
                margin-top: -5%;
            }

            .input-label {
                color: #ffffff;
                font-size: 1.1rem;
                font-weight: bold;
                margin-bottom: 5px;
                display: block;
                width: 100%;
                text-align: left;
            }

            .input-area {
                position: relative;
                width: 100%;
                display: flex;
                justify-content: flex-start;
                overflow: visible;
            }

            #fromBox,
            #toBox {
                background-color: #041f76;
                border-radius: 10px;
                width: 100%;
                height: 46px;
                padding: 0 15px;
                font-size: 0.95rem;
                border: 2px solid rgb(5, 5, 79);
                color: white;
                transition: border-color 0.3s;
                margin-bottom: 0;
            }

            #fromBox:focus,
            #toBox:focus {
                outline: none;
                border-color: #e0e2ea;
            }

            input::placeholder {
                color: rgba(255, 255, 255, 0.8);
            }

            .dropdown {
                margin-top: 0;
                margin-left: 2%;
                display: none;
                position: absolute;
                top: 110%;
                left: 0;
                width: 94%;
                max-height: 215px;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #597ae8;
                border-top: none;
                border-radius: 0 0 10px 10px;
                list-style-type: none;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(89, 87, 87, 0.1);
            }

            .dropdown li {
                padding: 10px 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                font-size: 1.2rem;
                text-align: center;
                transition: all 0.2s;
                font-family: 'Times New Roman', Times, serif;
            }

            .dropdown li:last-child {
                border-bottom: none;
            }

            .dropdown li:hover {
                background-color: #bbadad;
                color: #1a49e2;
            }

            .swap-container {
                display: flex;
                align-items: center;
                justify-content: flex-end;
                width: 100%;
                padding: 6px 0;
                margin: 0;
            }

            .swapbox {
                width: 44px;
                height: 44px;
                cursor: pointer;
                border-radius: 18px;
                transition: transform 0.3s;
                background-color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 22px;
            }

            .swapbox:hover {
                transform: scale(1.1);
            }

            .rotate-once {
                animation: rotateOnce 0.35s ease-in-out forwards;
            }

            @keyframes rotateOnce {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(180deg);
                }
            }

            .button-container {
                display: flex;
                justify-content: center;
                gap: 12px;
                margin-top: 14px;
                margin-bottom: 10px;
                width: 100%;
            }

            button {
                background-color: rgb(5, 5, 79);
                color: white;
                width: 100%;
                height: 42px;
                border-radius: 18px;
                font-size: 0.95rem;
                border: 2px solid rgb(5, 5, 79);
                cursor: pointer;
                transition: all 0.3s;
                font-weight: bold;
            }

            button:hover {
                background-color: yellow;
                color: rgb(10, 10, 10);
                border-color: yellow;
                transform: translateY(-2px);
            }

            .search-icon {
                display: none;
            }

            .search-text {
                display: inline;
            }

            .map-section {
                flex: 1;
                height: 100vh;
                position: relative;
                background-color: #f5f5f5;
                overflow: hidden;
            }

            /* ‚îÄ‚îÄ Desktop Route Info Stack ‚îÄ‚îÄ */
            #desktopRouteInfoStack {
                display: block;
                width: 100%;
                margin-top: 12px;
                padding-bottom: 20px;
            }

            .route-info-box {
                width: 100%;
                background: rgba(255, 255, 255, 0.10);
                border: 1.5px solid rgba(255, 255, 255, 0.20);
                border-radius: 12px;
                padding: 10px 13px;
                margin-bottom: 7px;
                cursor: pointer;
                transition: all 0.25s ease;
                position: relative;
                overflow: hidden;
            }

            .route-info-box::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 12px 0 0 12px;
                transition: background 0.25s;
            }

            .route-info-box.active-route {
                background: rgba(255, 255, 255, 0.20);
                border-color: rgba(255, 255, 255, 0.55);
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.22);
                transform: translateX(2px);
            }

            .route-info-box.active-route::before {
                background: #FFE000;
            }

            .route-info-box:hover:not(.active-route) {
                background: rgba(255, 255, 255, 0.16);
                border-color: rgba(255, 255, 255, 0.35);
                transform: translateX(2px);
            }

            .route-box-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 6px;
            }

            .route-box-label {
                font-size: 0.70rem;
                font-weight: 700;
                color: rgba(255, 255, 255, 0.55);
                text-transform: uppercase;
                letter-spacing: 0.08em;
            }

            .route-box-label.shortest {
                color: #FFE000;
            }

            .route-box-badge {
                font-size: 0.62rem;
                background: rgba(255, 255, 255, 0.13);
                color: rgba(255, 255, 255, 0.75);
                padding: 2px 7px;
                border-radius: 8px;
                font-weight: 600;
            }

            .route-box-badge.active-badge {
                background: #FFE000;
                color: #1a1a1a;
            }

            .route-box-stats {
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .route-stat {
                display: flex;
                flex-direction: column;
            }

            .route-stat-value {
                font-size: 1.0rem;
                font-weight: 700;
                color: #ffffff;
                line-height: 1.1;
            }

            .route-stat-unit {
                font-size: 0.62rem;
                color: rgba(255, 255, 255, 0.55);
                text-transform: uppercase;
                letter-spacing: 0.06em;
            }

            .route-stat-divider {
                width: 1px;
                height: 26px;
                background: rgba(255, 255, 255, 0.22);
            }

            /* Hide mobile box on desktop */
            #mobileRouteInfo {
                display: none !important;
            }
        }

        /* ===================== MOBILE ===================== */
        @media screen and (max-width: 768px) {
            nav {
                background-color: rgb(158, 5, 228);
                width: 100%;
                padding: 15px;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-shrink: 0;
                overflow: visible;
                position: relative;
                z-index: 2000;
            }
            p{
                color: wheat;
                margin-top: -2%;
            }

            .nav-container {
                width: 100%;
                max-width: 100%;
                margin: 0 auto;
                overflow: visible;
            }

            .title-container {
                text-align: center;
                margin-bottom: 20px;
            }

            .head1 {
                font-size: 1.8rem;
                font-family: Georgia, 'Times New Roman', Times, serif;
                color: white;
                margin-bottom: 15px;
            }

            .input-section {
                width: 100%;
                position: relative;
                z-index: 200;
                overflow: visible;
            }

            .input-row {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                gap: 10px 12px;
                align-items: center;
                width: 100%;
                margin: 0;
                overflow: visible;
            }

            .swap-container {
                grid-column: 2;
                grid-row: 1 / span 2;
                display: flex;
                justify-content: center;
                align-items: center;
                width: 50px;
                margin: 0;
                padding: 0;
            }

            .swapbox {
                width: 42px;
                height: 42px;
                cursor: pointer;
                border-radius: 14px;
                transition: transform 0.3s;
                background-color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 22px;
            }

            .swapbox {
                transition: transform 0.3s;
            }

            .rotate-once {
                animation: rotateOnce 0.35s ease-in-out forwards;
            }

            @keyframes rotateOnce {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(180deg);
                }
            }

            .input-wrapper {
                grid-column: 1;
                width: 100%;
                margin: 0;
                position: relative;
                overflow: visible;
            }

            .input-wrapper:first-child {
                grid-row: 1;
                z-index: 202;
            }

            .input-wrapper:last-child {
                grid-row: 2;
                z-index: 201;
            }

            .input-label {
                display: none;
            }

            .input-area {
                position: relative;
                width: 100%;
                display: flex;
                overflow: visible;
            }

            #fromBox,
            #toBox {
                background-color: #041f76;
                border-radius: 10px;
                width: 100%;
                height: 44px;
                padding: 0 15px;
                font-size: 1rem;
                border: 2px solid rgb(5, 5, 79);
                color: white;
                transition: border-color 0.3s;
            }

            #fromBox:focus,
            #toBox:focus {
                outline: none;
                border-color: #e0e2ea;
            }

            input::placeholder {
                color: rgba(255, 255, 255, 0.8);
            }

            .dropdown {
                width: 95%;
                display: none;
                position: absolute;
                top: 115%;
                left: 0;
                margin-left: 2%;
                max-height: 220px;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #597ae8;
                border-top: none;
                border-radius: 0 0 10px 10px;
                list-style-type: none;
                z-index: 99999;
                box-shadow: 0 4px 12px rgba(89, 87, 87, 0.1);
            }

            .dropdown li {
                padding: 10px 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                font-size: 18px;
                text-align: center;
                transition: all 0.2s;
                font-family: 'Times New Roman', Times, serif;
            }

            .dropdown li:last-child {
                border-bottom: none;
            }

            .dropdown li:hover {
                background-color: #bbadad;
                color: #1a49e2;
            }

            .button-container {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: 12px;
                width: 100%;
            }

            button {
                background-color: rgb(5, 5, 79);
                color: white;
                width: 100%;
                height: 40px;
                border-radius: 12px;
                font-size: 1rem;
                border: 2px solid rgb(5, 5, 79);
                cursor: pointer;
                transition: all 0.3s;
                font-weight: bold;
            }

            button:hover {
                background-color: yellow;
                color: rgb(10, 10, 10);
                border-color: yellow;
                transform: translateY(-2px);
            }

            .search-icon {
                display: inline;
                font-size: 18px;
            }

            .map-section {
                z-index: 1;
                flex: 1;
                width: 100%;
                position: relative;
                background-color: #f5f5f5;
                overflow: hidden;
            }

            /* Hide desktop stack on mobile */
            #desktopRouteInfoStack {
                display: none !important;
            }

            /* ‚îÄ‚îÄ Mobile Route Info Box (bottom-left of map) ‚îÄ‚îÄ */
            #mobileRouteInfo {
                position: absolute;
                bottom: 50px;
                left: 14px;
                z-index: 1000;
                background: rgba(4, 31, 118, 0.93);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1.5px solid rgba(255, 255, 255, 0.25);
                border-radius: 14px;
                padding: 11px 15px;
                min-width: 145px;
                display: none;
                box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35);
            }

            #mobileRouteInfo.active {
                display: block;
                animation: mobilePopIn 0.32s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            }

            @keyframes mobilePopIn {
                from {
                    transform: scale(0.8) translateY(10px);
                    opacity: 0;
                }

                to {
                    transform: scale(1) translateY(0);
                    opacity: 1;
                }
            }

            .mobile-stat-label {
                font-size: 0.60rem;
                color: rgba(255, 255, 255, 0.55);
                text-transform: uppercase;
                letter-spacing: 0.07em;
                display: block;
                margin-bottom: 2px;
            }

            .mobile-stat-value {
                font-size: 1.25rem;
                font-weight: 800;
                color: #FFE000;
                line-height: 1.1;
                display: block;
            }

            .mobile-stat-divider {
                height: 1px;
                background: rgba(255, 255, 255, 0.15);
                margin: 7px 0;
            }

            .mobile-time-value {
                font-size: 1.05rem;
                font-weight: 700;
                color: #ffffff;
                line-height: 1.1;
                display: block;
            }
        }

        /* ===================== SHARED ===================== */
        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .current-location-btn {
            position: absolute;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            background-color: #007bff;
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .current-location-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        .landmark-toggle-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background-color: #28a745;
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .landmark-toggle-btn:hover {
            background-color: #218838;
            transform: scale(1.1);
        }

        .landmark-toggle-btn.inactive {
            background-color: #dc3545;
        }

        .landmark-toggle-btn.inactive:hover {
            background-color: #c82333;
        }

        /* Old nav-info-panel hidden entirely */
        .nav-info-panel {
            display: none !important;
        }

        .custom-landmark-marker {
            background: none;
            border: none;
        }

        .start-marker-icon {
            background: none;
            border: none;
        }

        .end-marker-icon {
            background: none;
            border: none;
        }

        .route-arrow-marker {
            background: none;
            border: none;
            pointer-events: none;
        }

        /* ===================== SIDEBAR ===================== */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --bg-light: #f8f9fa;
            --sidebar-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --transition: 0.3s ease;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
            z-index: 998;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 380px;
            height: 100vh;
            background: var(--sidebar-bg);
            box-shadow: -4px 0 20px var(--shadow-dark);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            right: 0;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .sidebar-content {
            padding: 20px;
            flex: 1;
        }

        .accordion-item {
            margin-bottom: 16px;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--bg-light);
            box-shadow: 0 2px 8px var(--shadow);
            transition: all var(--transition);
        }

        .accordion-item:hover {
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        .accordion-item summary {
            padding: 16px 20px;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--text-dark);
            background: white;
            transition: all var(--transition);
            user-select: none;
        }

        .accordion-item summary::-webkit-details-marker {
            display: none;
        }

        .accordion-item summary:hover {
            background: var(--bg-light);
            color: var(--accent-color);
        }

        .accordion-item[open] summary {
            background: var(--accent-color);
            color: white;
        }

        .accordion-item[open] summary .summary-icon {
            stroke: white;
        }

        .summary-icon {
            flex-shrink: 0;
            transition: all var(--transition);
        }

        .accordion-item[open] summary::after {
            content: '';
            margin-left: auto;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid white;
        }

        .accordion-item:not([open]) summary::after {
            content: '';
            margin-left: auto;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 8px solid var(--text-dark);
        }

        .department-list {
            list-style: none;
            padding: 16px 20px;
            background: white;
        }

        .department-list li {
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--bg-light);
            border-radius: 8px;
            color: var(--text-dark);
            font-size: 0.95rem;
            transition: all var(--transition);
            border-left: 3px solid transparent;
        }

        .department-list li:hover {
            background: #e8f4fd;
            border-left-color: var(--accent-color);
            transform: translateX(4px);
        }

        .floor-info {
            padding: 16px 20px;
            background: white;
        }

        .room-range {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        .floor-desc {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        .location-link {
            color: #1967d2;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-link:hover {
            color: #0d47a1;
            text-decoration: underline;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                max-width: 100%;
            }

            .sidebar-header h1 {
                font-size: 1.5rem;
            }

            .accordion-item summary {
                padding: 14px 16px;
                font-size: 1rem;
            }

            .department-list li {
                padding: 10px 14px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .sidebar-header {
                padding: 20px;
            }

            .sidebar-content {
                padding: 15px;
            }
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .close-btn:focus,
        .accordion-item summary:focus {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-container">
            <div class="title-container">
                <h1 class="head1">FIND YOUR WAY</h1>
                <p>Campus Navigation Assistant</p>
            </div>
            <div class="input-section">
                <div class="input-row">
                    <div class="input-wrapper" id="from-area">
                        <label class="input-label" for="fromBox">From:</label>
                        <div class="input-area">
                            <input type="text" id="fromBox" placeholder="Enter Your Current Location"
                                onclick="showList('fromList')" onkeyup="filterItems('fromBox', 'fromList')">
                            <ul id="fromList" class="dropdown"></ul>
                        </div>
                    </div>
                    <div class="swap-container">
                        <div class="swapbox">&#8644;</div>
                    </div>
                    <div class="input-wrapper" id="to-area">
                        <label class="input-label" for="toBox">To:</label>
                        <div class="input-area">
                            <input type="text" id="toBox" placeholder="Enter Your Destination"
                                onclick="showList('toList')" onkeyup="filterItems('toBox', 'toList')">
                            <ul id="toList" class="dropdown"></ul>
                        </div>
                    </div>
                </div>
                <div class="button-container">
                    <button id="but1" onclick="searchRoute()"><span class="search-text">Search
                            &rsaquo;&rsaquo;</span></button>
                    <button id="but2" onclick="clearRoute()"><span class="search-text">Clear &#10060;</span></button>
                </div>
            </div>
            <!-- Desktop route info stack lives here, below buttons -->
            <div id="desktopRouteInfoStack"></div>
        </div>
    </nav>

    <div id="mapSection" class="map-section">
        <button id="currentLocationBtn" class="current-location-btn"><i class="fas fa-location-crosshairs"></i></button>
        <button id="landmarkToggleBtn" class="landmark-toggle-btn"><i class="fas fa-map-pin"></i></button>
        <!-- Hidden legacy panel -->
        <div id="navInfoPanel" class="nav-info-panel">
            <div id="navDistance" class="nav-info-distance">0 meters</div>
            <div id="navTime" class="nav-info-time">0 minutes</div>
        </div>
        <!-- Mobile bottom-left route info -->
        <div id="mobileRouteInfo">
            <span class="mobile-stat-label">Distance</span>
            <span class="mobile-stat-value" id="mobileDistVal">&#8212;</span>
            <div class="mobile-stat-divider"></div>
            <span class="mobile-stat-label">Est. Walk</span>
            <span class="mobile-time-value" id="mobileTimeVal">&#8212;</span>
        </div>
        <div id="mapContainer" class="map-container"></div>
    </div>

    <div id="overlay" class="overlay"></div>
    <aside id="sideMenu" class="sidebar" role="complementary">
        <div class="sidebar-header">
            <h1>E Block</h1>
            <button class="close-btn" id="closeBtn" aria-label="Close sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="sidebar-content">
            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Departments
                </summary>
                <ul class="department-list">
                    <li>B.Sc Computer Science</li>
                    <li>B.Sc Computer Application</li>
                    <li>B.Sc Computer Technology</li>
                    <li>B.Sc Data Analytics</li>
                    <li>B.Sc Computer Networks</li>
                    <li>B.Sc Information Technology</li>
                    <li>M.Sc Software Systems</li>
                </ul>
            </details>
            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Ground Floor
                </summary>
                <div class="floor-info">
                    <p class="room-range">Rooms: E101 - E120</p>
                    <p class="floor-desc">20 rooms available</p>
                </div>
            </details>
            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    First Floor
                </summary>
                <div class="floor-info">
                    <p class="room-range">Rooms: E201 - E220</p>
                    <p class="floor-desc">20 rooms available</p>
                </div>
            </details>
            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Second Floor
                </summary>
                <div class="floor-info">
                    <p class="room-range">Rooms: E301 - E320</p>
                    <p class="floor-desc">20 rooms available</p>
                </div>
            </details>
        </div>
    </aside>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // ---------- GLOBALS ----------
        let campusMap, userLocationMarker, accuracyCircle;
        let userWatchId = null, userLatLng = null;
        let startMarker = null, endMarker = null;
        let routeLayerGroup = null, landmarkMarkersLayer = null;
        let landmarksVisible = true, animationFrameId = null;
        let arrowMarker = null, arrowAnimFrameId = null, arrowRouteLatlngs = [], arrowProgress = 0;
        const ARROW_SPEED = 0.00012;
        let isNavigating = false, currentDestination = null, fullRoutePath = [], currentPathIndices = [];
        let lastUpdateTime = 0;
        const UPDATE_THRESHOLD = 2000, PROXIMITY_THRESHOLD = 15, DEVIATION_THRESHOLD = 25;
        let graph = { nodes: [], edges: [] }, nodeIndex = new Map(), places = [];
        let lastResults, activeRouteIndex = 0;
        const KROUTES = 5;

        const landmarks = [
            { "id": "front", "name": "Front Gate", "lat": 11.034770, "lng": 77.033850 },
            { "id": "admiss", "name": "Admission Office", "lat": 11.032585, "lng": 77.033888 },
            { "id": "lib", "name": "Library", "lat": 11.033664, "lng": 77.033435 },
            { "id": "prin", "name": "Principal Office", "lat": 11.033269, "lng": 77.033861 },
            { "id": "sf", "name": "S F Office", "lat": 11.033111, "lng": 77.033410 },
            { "id": "aided", "name": "Aided Office", "lat": 11.033277, "lng": 77.034183 },
            { "id": "hostel", "name": "Hostel Office", "lat": 11.032646, "lng": 77.035449 },
            { "id": "can1", "name": "Canteen 1", "lat": 11.033695, "lng": 77.034336 },
            { "id": "can2", "name": "Canteen 2", "lat": 11.032013, "lng": 77.032709 },
            { "id": "grd", "name": "GRD Auditorium", "lat": 11.032415, "lng": 77.033340 },
            { "id": "indoor", "name": "Indoor Auditorium", "lat": 11.033714, "lng": 77.035304 },
            { "id": "ab", "name": "A Block", "lat": 11.033230, "lng": 77.032509 },
            { "id": "bb", "name": "B Block", "lat": 11.033238, "lng": 77.033060 },
            { "id": "cb", "name": "C Block", "lat": 11.032585, "lng": 77.033888 },
            { "id": "db", "name": "D Block", "lat": 11.033280, "lng": 77.034520 },
            { "id": "eb", "name": "E Block", "lat": 11.032854, "lng": 77.034351 },
            { "id": "fb", "name": "F Block", "lat": 11.032585, "lng": 77.033888 },
            { "id": "gb", "name": "G Block", "lat": 11.032609, "lng": 77.034594 },
            { "id": "qb", "name": "Q Block", "lat": 11.034020, "lng": 77.034499 },
            { "id": "book", "name": "Book Depot", "lat": 11.033405, "lng": 77.033032 },
            { "id": "pothigai", "name": "Pothigai Hall", "lat": 11.033372, "lng": 77.033410 },
            { "id": "bharathi", "name": "Bharathi Hostel", "lat": 11.032652, "lng": 77.035604 },
            { "id": "nri", "name": "NRI Hostel", "lat": 11.032658, "lng": 77.035785 },
            { "id": "back", "name": "Back Gate", "lat": 11.031834, "lng": 77.036534 }
        ];

        const locationmarker = [
            { "id": "front", "name": "Front Gate", "lat": 11.034820, "lng": 77.033845, "icon": "‚õ©Ô∏è" },
            { "id": "admiss", "name": "Admission Office", "lat": 11.032726, "lng": 77.033547, "icon": "üíº" },
            { "id": "lib", "name": "Library", "lat": 11.033706, "lng": 77.033437, "icon": "üìö" },
            { "id": "prin", "name": "Principal Office", "lat": 11.033200, "lng": 77.033947, "icon": "üíº" },
            { "id": "sf", "name": "S F Office", "lat": 11.033105, "lng": 77.033502, "icon": "üíº" },
            { "id": "aided", "name": "Aided Office", "lat": 11.033190, "lng": 77.034094, "icon": "üíº" },
            { "id": "hostel", "name": "Hostel Office", "lat": 11.032776, "lng": 77.035441, "icon": "üíº" },
            { "id": "can1", "name": "Canteen 1", "lat": 11.033762, "lng": 77.034287, "icon": "üçΩÔ∏è" },
            { "id": "can2", "name": "Canteen 2", "lat": 11.031994, "lng": 77.032606, "icon": "üçΩÔ∏è" },
            { "id": "grd", "name": "GRD Auditorium", "lat": 11.032361, "lng": 77.033290, "icon": "üé≠" },
            { "id": "ab", "name": "A Block", "lat": 11.033140, "lng": 77.032508, "icon": "üèõÔ∏è" },
            { "id": "bb", "name": "B Block", "lat": 11.033161, "lng": 77.033059, "icon": "üèõÔ∏è" },
            { "id": "cb", "name": "C Block", "lat": 11.032713, "lng": 77.033874, "icon": "üèõÔ∏è" },
            { "id": "db", "name": "D Block", "lat": 11.033285, "lng": 77.034627, "icon": "üèõÔ∏è" },
            { "id": "eb", "name": "E Block", "lat": 11.032845, "lng": 77.034410, "icon": "üèõÔ∏è" },
            { "id": "fb", "name": "F Block", "lat": 11.032500, "lng": 77.033893, "icon": "üèõÔ∏è" },
            { "id": "gb", "name": "G Block", "lat": 11.032389, "lng": 77.034572, "icon": "üèõÔ∏è" },
            { "id": "qb", "name": "Q Block", "lat": 11.034030, "lng": 77.034620, "icon": "üèõÔ∏è" },
            { "id": "football", "name": "FootBall Ground", "lat": 11.031483, "lng": 77.033107, "icon": "‚öΩ" },
            { "id": "Tennis", "name": "Tennis Court", "lat": 11.031824, "lng": 77.033979, "icon": "üè∏" },
            { "id": "Hockey", "name": "Hockey Ground", "lat": 11.031281, "lng": 77.033974, "icon": "üèë" },
            { "id": "Volleyball", "name": "Volleyball Court", "lat": 11.032467, "lng": 77.036240, "icon": "üèê" },
            { "id": "Khokho", "name": "Khokho Court", "lat": 11.030778, "lng": 77.033976, "icon": "üèÉ‚Äç‚ôÄÔ∏è" },
            { "id": "Basketball", "name": "Basketball Court", "lat": 11.032139, "lng": 77.036283, "icon": "üèÄ" },
            { "id": "indoor", "name": "Indoor Auditorium", "lat": 11.033304, "lng": 77.035299, "icon": "‚õπÔ∏è" },
            { "id": "Parking", "name": "Students Bike Parking Area", "lat": 11.034749, "lng": 77.034258, "icon": "üèçÔ∏è" },
            { "id": "Parking", "name": "Staff Parking", "lat": 11.034203, "lng": 77.033518, "icon": "üÖøÔ∏è" },
            { "id": "Parking", "name": "Students Car Parking Area", "lat": 11.033577, "lng": 77.036263, "icon": "üöó" },
            { "id": "back", "name": "Back Gate", "lat": 11.031834, "lng": 77.036534, "icon": "‚õ©Ô∏è" }
        ];

        const graphData = {
            "nodes": [
                { "id": "G1", "lat": 11.034820, "lng": 77.033845 }, { "id": "G2", "lat": 11.034563, "lng": 77.033848 },
                { "id": "G3", "lat": 11.034280, "lng": 77.033855 }, { "id": "G4", "lat": 11.034310, "lng": 77.034100 },
                { "id": "G5", "lat": 11.034325, "lng": 77.034371 }, { "id": "G6", "lat": 11.034343, "lng": 77.034768 },
                { "id": "G7", "lat": 11.034369, "lng": 77.035226 }, { "id": "G8", "lat": 11.034391, "lng": 77.035535 },
                { "id": "G9", "lat": 11.033964, "lng": 77.035553 }, { "id": "G10", "lat": 11.034000, "lng": 77.035806 },
                { "id": "G11", "lat": 11.034019, "lng": 77.035980 }, { "id": "G12", "lat": 11.034009, "lng": 77.036093 },
                { "id": "G13", "lat": 11.033956, "lng": 77.036219 }, { "id": "G14", "lat": 11.033834, "lng": 77.036351 },
                { "id": "G15", "lat": 11.033289, "lng": 77.036422 }, { "id": "G16", "lat": 11.032674, "lng": 77.036463 },
                { "id": "G17", "lat": 11.032278, "lng": 77.036498 }, { "id": "G18", "lat": 11.031834, "lng": 77.036534 },
                { "id": "G19", "lat": 11.034009, "lng": 77.033856 }, { "id": "G20", "lat": 11.033670, "lng": 77.033854 },
                { "id": "G21", "lat": 11.033666, "lng": 77.033679 }, { "id": "G22", "lat": 11.033664, "lng": 77.033435 },
                { "id": "G23", "lat": 11.033630, "lng": 77.033403 }, { "id": "G24", "lat": 11.033372, "lng": 77.033410 },
                { "id": "G25", "lat": 11.033250, "lng": 77.033413 }, { "id": "G26", "lat": 11.033248, "lng": 77.033060 },
                { "id": "G27", "lat": 11.033240, "lng": 77.032791 }, { "id": "G28", "lat": 11.033230, "lng": 77.032509 },
                { "id": "G29", "lat": 11.033111, "lng": 77.033410 }, { "id": "G30", "lat": 11.032566, "lng": 77.033426 },
                { "id": "G31", "lat": 11.032410, "lng": 77.033432 }, { "id": "G32", "lat": 11.032415, "lng": 77.033340 },
                { "id": "G33", "lat": 11.032410, "lng": 77.033218 }, { "id": "G34", "lat": 11.032413, "lng": 77.032941 },
                { "id": "G35", "lat": 11.032558, "lng": 77.033215 }, { "id": "G36", "lat": 11.032550, "lng": 77.032936 },
                { "id": "G37", "lat": 11.032545, "lng": 77.032686 }, { "id": "G38", "lat": 11.032397, "lng": 77.032700 },
                { "id": "G39", "lat": 11.032179, "lng": 77.032700 }, { "id": "G40", "lat": 11.032013, "lng": 77.032709 },
                { "id": "G41", "lat": 11.033400, "lng": 77.033864 }, { "id": "G42", "lat": 11.033266, "lng": 77.033756 },
                { "id": "G43", "lat": 11.033269, "lng": 77.033861 }, { "id": "G44", "lat": 11.033270, "lng": 77.033949 },
                { "id": "G45", "lat": 11.033277, "lng": 77.034183 }, { "id": "G46", "lat": 11.033274, "lng": 77.034335 },
                { "id": "G47", "lat": 11.033687, "lng": 77.034317 }, { "id": "G48", "lat": 11.033690, "lng": 77.034505 },
                { "id": "G49", "lat": 11.034020, "lng": 77.034499 }, { "id": "G50", "lat": 11.034161, "lng": 77.034480 },
                { "id": "G51", "lat": 11.034203, "lng": 77.034380 }, { "id": "G52", "lat": 11.033114, "lng": 77.034342 },
                { "id": "G53", "lat": 11.032854, "lng": 77.034345 }, { "id": "G54", "lat": 11.032605, "lng": 77.034346 },
                { "id": "G55", "lat": 11.032585, "lng": 77.033888 }, { "id": "G56", "lat": 11.032609, "lng": 77.034594 },
                { "id": "G57", "lat": 11.032630, "lng": 77.035112 }, { "id": "G58", "lat": 11.033135, "lng": 77.035095 },
                { "id": "G59", "lat": 11.033130, "lng": 77.034715 }, { "id": "G60", "lat": 11.033706, "lng": 77.035081 },
                { "id": "G61", "lat": 11.033711, "lng": 77.035527 }, { "id": "G62", "lat": 11.033743, "lng": 77.035548 },
                { "id": "G63", "lat": 11.032650, "lng": 77.035551 }, { "id": "G64", "lat": 11.032646, "lng": 77.035449 },
                { "id": "G65", "lat": 11.032638, "lng": 77.035259 }, { "id": "G66", "lat": 11.032652, "lng": 77.035604 },
                { "id": "G67", "lat": 11.032658, "lng": 77.035785 }, { "id": "G68", "lat": 11.032665, "lng": 77.036175 },
                { "id": "G69", "lat": 11.032188, "lng": 77.035270 }, { "id": "G70", "lat": 11.031744, "lng": 77.035278 },
                { "id": "G71", "lat": 11.031262, "lng": 77.035285 }, { "id": "G72", "lat": 11.030725, "lng": 77.035295 },
                { "id": "G73", "lat": 11.032163, "lng": 77.034363 }, { "id": "G74", "lat": 11.032160, "lng": 77.033896 },
                { "id": "G75", "lat": 11.032140, "lng": 77.033440 }, { "id": "G76", "lat": 11.032534, "lng": 77.032396 },
                { "id": "G77", "lat": 11.032587, "lng": 77.032278 }, { "id": "G78", "lat": 11.032690, "lng": 77.032223 },
                { "id": "G79", "lat": 11.033037, "lng": 77.032115 }, { "id": "G80", "lat": 11.033182, "lng": 77.032198 },
                { "id": "G81", "lat": 11.033232, "lng": 77.032396 }, { "id": "G82", "lat": 11.033280, "lng": 77.034520 },
                { "id": "G83", "lat": 11.033245, "lng": 77.033032 }, { "id": "G84", "lat": 11.033405, "lng": 77.033032 },
                { "id": "G85", "lat": 11.033714, "lng": 77.035304 }
            ],
            "edges": [
                ["G1", "G2"], ["G2", "G3"], ["G3", "G4"], ["G4", "G5"], ["G5", "G6"],
                ["G6", "G7"], ["G7", "G8"], ["G8", "G9"], ["G9", "G10"], ["G10", "G11"],
                ["G11", "G12"], ["G12", "G13"], ["G13", "G14"], ["G14", "G15"], ["G15", "G16"],
                ["G16", "G17"], ["G17", "G18"], ["G9", "G62"], ["G62", "G61"], ["G61", "G63"],
                ["G63", "G66"], ["G66", "G67"], ["G67", "G68"], ["G68", "G16"], ["G5", "G51"],
                ["G51", "G50"], ["G50", "G49"], ["G49", "G48"], ["G48", "G60"],
                ["G60", "G58"], ["G58", "G57"], ["G57", "G65"], ["G65", "G64"], ["G64", "G63"],
                ["G57", "G56"], ["G56", "G54"], ["G3", "G19"], ["G19", "G20"], ["G20", "G47"],
                ["G47", "G46"], ["G47", "G48"], ["G46", "G52"], ["G52", "G59"], ["G46", "G82"],
                ["G59", "G58"], ["G52", "G53"], ["G53", "G54"], ["G20", "G41"], ["G41", "G44"],
                ["G44", "G45"], ["G45", "G46"], ["G44", "G43"], ["G41", "G42"], ["G42", "G43"],
                ["G42", "G25"], ["G20", "G21"], ["G21", "G22"], ["G22", "G23"], ["G23", "G24"],
                ["G24", "G25"], ["G25", "G29"], ["G29", "G30"], ["G30", "G31"], ["G31", "G32"],
                ["G30", "G55"], ["G54", "G55"], ["G32", "G33"], ["G30", "G35"], ["G35", "G33"],
                ["G35", "G36"], ["G36", "G37"], ["G33", "G34"], ["G36", "G34"], ["G36", "G57"],
                ["G34", "G38"], ["G37", "G38"], ["G38", "G39"], ["G39", "G40"], ["G25", "G26"],
                ["G26", "G27"], ["G27", "G28"], ["G28", "G81"], ["G81", "G80"], ["G80", "G79"],
                ["G79", "G78"], ["G78", "G77"], ["G77", "G76"], ["G76", "G37"], ["G31", "G75"],
                ["G54", "G73"], ["G73", "G74"], ["G74", "G75"], ["G55", "G74"], ["G65", "G69"],
                ["G69", "G70"], ["G70", "G71"], ["G71", "G72"], ["G26", "G83"], ["G84", "G83"],
                ["G60", "G85"], ["G61", "G85"]
            ]
        };

        const locationsList = [
            'Current Location', 'Front Gate', 'Admission Office', 'Library', 'Principal Office',
            'S F Office', 'Aided Office', 'Hostel Office', 'Canteen 1', 'Canteen 2',
            'GRD Auditorium', 'Indoor Auditorium', 'A Block', 'B Block', 'C Block', 'D Block',
            'E Block', 'F Block', 'G Block', 'Q Block', 'Book Depot', 'Pothigai Hall',
            'Bharathi Hostel', 'NRI Hostel', 'Back Gate'
        ];

        const landmarkMapping = {
            'Front Gate': 'front', 'Admission Office': 'admiss', 'Library': 'lib',
            'Principal Office': 'prin', 'S F Office': 'sf', 'Aided Office': 'aided',
            'Hostel Office': 'hostel', 'Canteen 1': 'can1', 'Canteen 2': 'can2',
            'GRD Auditorium': 'grd', 'Indoor Auditorium': 'indoor', 'A Block': 'ab',
            'B Block': 'bb', 'C Block': 'cb', 'D Block': 'db', 'E Block': 'eb',
            'F Block': 'fb', 'G Block': 'gb', 'Q Block': 'qb', 'Book Depot': 'book',
            'Pothigai Hall': 'pothigai', 'Bharathi Hostel': 'bharathi', 'NRI Hostel': 'nri',
            'Back Gate': 'back'
        };

        // ‚ïê‚ïê ROUTE INFO PANEL UTILITIES ‚ïê‚ïê
        function isMobile() { return window.innerWidth <= 768; }

        function fmtDist(m) {
            if (m >= 1000) return (m / 1000).toFixed(2) + ' km';
            return Math.round(m) + ' m';
        }
        function fmtTime(m) {
            const mins = Math.ceil(m / 1.4 / 60);
            return mins < 1 ? '< 1 min' : mins + ' min';
        }

        function renderDesktopRouteStack(results, activeIdx) {
            const stack = document.getElementById('desktopRouteInfoStack');
            if (!stack) return;
            stack.innerHTML = '';
            if (!results || !results.length) return;
            // sort ascending by distance, keep original index
            const sorted = results
                .map((r, i) => ({ ...r, origIdx: i }))
                .sort((a, b) => a.distance - b.distance);

            sorted.forEach((res, si) => {
                const isActive = res.origIdx === activeIdx;
                const box = document.createElement('div');
                box.className = 'route-info-box' + (isActive ? ' active-route' : '');
                const label = si === 0 ? 'Shortest Route' : 'Route ' + (si + 1);
                const badgeText = isActive ? '&#9679; Active' : 'View';
                box.innerHTML = `
                    <div class="route-box-header">
                        <span class="route-box-label${si === 0 ? ' shortest' : ''}">${label}</span>
                        <span class="route-box-badge${isActive ? ' active-badge' : ''}">${badgeText}</span>
                    </div>
                    <div class="route-box-stats">
                        <div class="route-stat">
                            <span class="route-stat-value">${fmtDist(res.distance)}</span>
                            <span class="route-stat-unit">Distance</span>
                        </div>
                        <div class="route-stat-divider"></div>
                        <div class="route-stat">
                            <span class="route-stat-value">${fmtTime(res.distance)}</span>
                            <span class="route-stat-unit">Est. Walk</span>
                        </div>
                    </div>`;
                box.addEventListener('click', () => renderSelectedRoute(res.origIdx));
                stack.appendChild(box);
            });
        }

        function updateMobileRouteInfo(distance) {
            const box = document.getElementById('mobileRouteInfo');
            if (!box) return;
            if (distance == null || !isFinite(distance)) { box.classList.remove('active'); return; }
            document.getElementById('mobileDistVal').textContent = fmtDist(distance);
            document.getElementById('mobileTimeVal').textContent = fmtTime(distance);
            box.classList.add('active');
        }

        function clearRouteInfoPanels() {
            const stack = document.getElementById('desktopRouteInfoStack');
            if (stack) stack.innerHTML = '';
            const mob = document.getElementById('mobileRouteInfo');
            if (mob) mob.classList.remove('active');
        }

        // ‚ïê‚ïê ARROW ANIMATION ‚ïê‚ïê
        function buildCumDist(ll) {
            const c = [0];
            for (let i = 1; i < ll.length; i++) c.push(c[i - 1] + hav({ lat: ll[i - 1][0], lng: ll[i - 1][1] }, { lat: ll[i][0], lng: ll[i][1] }));
            return c;
        }
        function interpolateOnPath(ll, cum, prog) {
            const total = cum[cum.length - 1], target = prog * total;
            let lo = 0, hi = cum.length - 1;
            while (lo < hi - 1) { const mid = (lo + hi) >> 1; if (cum[mid] <= target) lo = mid; else hi = mid; }
            const sl = cum[hi] - cum[lo], t = sl > 0 ? (target - cum[lo]) / sl : 0;
            const a = ll[lo], b = ll[hi];
            const lat = a[0] + (b[0] - a[0]) * t, lng = a[1] + (b[1] - a[1]) * t;
            const dy = b[0] - a[0], dx = (b[1] - a[1]) * Math.cos(a[0] * Math.PI / 180);
            return { lat, lng, angleDeg: Math.atan2(dx, dy) * 180 / Math.PI };
        }
        function makeArrowIcon(deg) {
            return L.divIcon({ className: 'route-arrow-marker', html: `<svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg" style="transform:rotate(${deg}deg);filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));"><circle cx="18" cy="18" r="17" fill="rgba(255,230,0,0.22)"/><circle cx="18" cy="18" r="13" fill="#FFE000" stroke="#ff9900" stroke-width="2"/><polygon points="18,6 24,22 18,18 12,22" fill="#cc6600"/><circle cx="18" cy="25" r="2.5" fill="#cc6600"/></svg>`, iconSize: [36, 36], iconAnchor: [18, 18] });
        }
        function startArrowAnimation(ll, sp = 0) {
            stopArrowAnimation();
            if (!ll || ll.length < 2) return;
            arrowRouteLatlngs = ll; arrowProgress = sp;
            const cum = buildCumDist(ll), init = interpolateOnPath(ll, cum, sp);
            if (!arrowMarker) arrowMarker = L.marker([init.lat, init.lng], { icon: makeArrowIcon(init.angleDeg), zIndexOffset: 1200, interactive: false }).addTo(campusMap);
            else { arrowMarker.setLatLng([init.lat, init.lng]); arrowMarker.setIcon(makeArrowIcon(init.angleDeg)); }
            let lts = null;
            function loop(ts) {
                if (lts !== null) { arrowProgress += ARROW_SPEED * (ts - lts); if (arrowProgress >= 1) arrowProgress = 0; }
                lts = ts;
                const p = interpolateOnPath(arrowRouteLatlngs, cum, arrowProgress);
                arrowMarker.setLatLng([p.lat, p.lng]); arrowMarker.setIcon(makeArrowIcon(p.angleDeg));
                arrowAnimFrameId = requestAnimationFrame(loop);
            }
            arrowAnimFrameId = requestAnimationFrame(loop);
        }
        function stopArrowAnimation() {
            if (arrowAnimFrameId) { cancelAnimationFrame(arrowAnimFrameId); arrowAnimFrameId = null; }
            if (arrowMarker) { campusMap.removeLayer(arrowMarker); arrowMarker = null; }
            arrowRouteLatlngs = []; arrowProgress = 0;
        }

        // ‚ïê‚ïê SIDEBAR ‚ïê‚ïê
        function openSidebar() { document.getElementById('sideMenu').classList.add('open'); document.getElementById('overlay').classList.add('active'); document.body.style.overflow = 'hidden'; setTimeout(() => document.getElementById('closeBtn').focus(), 100); }
        function closeSidebar() { document.getElementById('sideMenu').classList.remove('open'); document.getElementById('overlay').classList.remove('active'); document.body.style.overflow = ''; }

        function createStartIcon() { return L.divIcon({ className: 'start-marker-icon', html: `<svg width="30" height="30" viewBox="0 0 34 34"><circle cx="15" cy="15" r="14" fill="#000000"/><circle cx="15" cy="15" r="9.5" fill="#ffffff"/></svg>`, iconSize: [30, 30], iconAnchor: [17, 17], popupAnchor: [0, -18] }); }
        function createEndIcon() { return L.divIcon({ className: 'end-marker-icon', html: `<svg width="25" height="32" viewBox="0 0 30 42"><path d="M15 0 C6.7 0 0 6.7 0 15 C0 26 15 42 15 42 C15 42 30 26 30 15 C30 6.7 23.3 0 15 0Z" fill="#e53935"/><circle cx="15" cy="15" r="6.5" fill="#b71c1c"/><circle cx="15" cy="15" r="3" fill="#ffffff"/></svg>`, iconSize: [30, 42], iconAnchor: [15, 42], popupAnchor: [0, -44] }); }

        function animatedPolyline(ll, opts, dur = 3000) {
            const pl = L.polyline([], opts), st = Date.now(), tot = ll.length;
            function animate() {
                const el = Date.now() - st, prog = Math.min(el / dur, 1), pts = Math.floor(prog * tot);
                if (pts > 0) { const part = ll.slice(0, pts); if (prog < 1 && pts < tot) { const s = (prog * tot) - pts, c = ll[pts - 1], n = ll[pts]; part.push([c[0] + (n[0] - c[0]) * s, c[1] + (n[1] - c[1]) * s]); } pl.setLatLngs(part); }
                if (prog < 1) animationFrameId = requestAnimationFrame(animate);
            }
            animate(); return pl;
        }

        function filterItems(iid, lid) {
            const inp = document.getElementById(iid), lst = document.getElementById(lid), items = Array.from(lst.getElementsByTagName('li')), f = inp.value.toLowerCase();
            items.forEach(i => i.style.display = 'none');
            if (!f) { items.forEach(i => i.style.display = ''); return; }
            items.forEach(i => { if (i.textContent.toLowerCase().startsWith(f)) i.style.display = ''; });
            items.forEach(i => { if (!i.textContent.toLowerCase().startsWith(f) && i.textContent.toLowerCase().includes(f)) i.style.display = ''; });
        }
        function showList(lid) { document.querySelectorAll('.dropdown').forEach(l => l.style.display = 'none'); document.getElementById(lid).style.display = 'block'; }
        function setupSwapButton() {
            const sw = document.querySelector('.swapbox');
            if (sw) {
                sw.addEventListener('click', () => {
                    const fb = document.getElementById('fromBox');
                    const tb = document.getElementById('toBox');

                    // Swap values
                    [fb.value, tb.value] = [tb.value, fb.value];

                    // Toggle rotation ‚Äî no more animation class mess
                    sw.classList.toggle('flipped');
                });
            }
        }
        function clearRoute() {
            document.getElementById('fromBox').value = ''; document.getElementById('toBox').value = '';
            document.querySelectorAll('.dropdown').forEach(l => l.style.display = 'none');
            isNavigating = false; currentDestination = null; fullRoutePath = []; currentPathIndices = []; activeRouteIndex = 0;
            clearRouteInfoPanels(); stopArrowAnimation();
            if (campusMap) clearRoutes();
        }
        function setupGlobalClickHandler() {
            document.addEventListener('click', function (e) {
                if (e.target.tagName === 'LI' && e.target.closest('.dropdown')) {
                    const inp = e.target.closest('.input-wrapper').querySelector('input');
                    if (inp) { inp.value = e.target.textContent; e.target.closest('.dropdown').style.display = 'none'; } return;
                }
                const inside = [...document.querySelectorAll('.input-wrapper')].some(w => w.contains(e.target));
                if (!inside) setTimeout(() => document.querySelectorAll('.dropdown').forEach(l => l.style.display = 'none'), 100);
            });
        }

        // ‚ïê‚ïê MAP SETUP ‚ïê‚ïê
        function initializeMap() {
            if (campusMap) { campusMap.invalidateSize(); return; }
            const cb = L.latLngBounds(L.latLng(11.029847, 77.032077), L.latLng(11.035600, 77.036616));
            campusMap = L.map('mapContainer', { maxBounds: cb, maxBoundsViscosity: 1.0, minZoom: 17, maxZoom: 19, preferCanvas: true, attributionControl: false }).setView([11.033400, 77.033864], 18);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '', updateWhenIdle: true, updateWhenZooming: false, keepBuffer: 2 }).addTo(campusMap);
            loadCampusData(); initializeLandmarkMarkers();
        }
        function loadCampusData() { places = landmarks; graph = JSON.parse(JSON.stringify(graphData)); nodeIndex = new Map(graph.nodes.map((n, i) => [n.id, i])); addLandmarkEntranceNodes(); }
        function hav(a, b) { const R = 6371000, toR = x => x * Math.PI / 180, dLat = toR(b.lat - a.lat), dLng = toR(b.lng - a.lng), s = Math.sin(dLat / 2) ** 2 + Math.cos(toR(a.lat)) * Math.cos(toR(b.lat)) * Math.sin(dLng / 2) ** 2; return 2 * R * Math.asin(Math.sqrt(s)); }
        function nearestPointOnSegment(p, a, b) { const px = p.lng, py = p.lat, ax = a.lng, ay = a.lat, bx = b.lng, by = b.lat, ABx = bx - ax, ABy = by - ay, APx = px - ax, APy = py - ay, ABAB = ABx * ABx + ABy * ABy, APAB = APx * ABx + APy * ABy; if (ABAB === 0) return { lat: a.lat, lng: a.lng }; const t = Math.max(0, Math.min(1, APAB / ABAB)); return { lat: ay + t * ABy, lng: ax + t * ABx }; }
        function addLandmarkEntranceNodes() {
            places.forEach(p => {
                const eId = `ENT_${p.id}`, eNode = { id: eId, lat: p.lat, lng: p.lng }; graph.nodes.push(eNode);
                let bd = Infinity, bnId = null, bEdge = null, bPt = null;
                for (let i = 0; i < graph.nodes.length - 1; i++) { const d = hav(p, graph.nodes[i]); if (d < bd) { bd = d; bnId = graph.nodes[i].id; bEdge = null; } }
                for (const [aId, bId] of graph.edges) { const ai = graph.nodes.findIndex(n => n.id === aId), bi = graph.nodes.findIndex(n => n.id === bId); if (ai === -1 || bi === -1) continue; const np = nearestPointOnSegment(p, graph.nodes[ai], graph.nodes[bi]), d = hav(p, np); if (d < bd) { bd = d; bEdge = [aId, bId]; bPt = np; bnId = null; } }
                if (bEdge && bPt) { const sId = `SPLIT_${p.id}`, sNode = { id: sId, lat: bPt.lat, lng: bPt.lng }; graph.nodes.push(sNode); const ei = graph.edges.findIndex(e => (e[0] === bEdge[0] && e[1] === bEdge[1]) || (e[0] === bEdge[1] && e[1] === bEdge[0])); if (ei !== -1) graph.edges.splice(ei, 1); graph.edges.push([bEdge[0], sId], [sId, bEdge[1]], [sId, eId]); }
                else if (bnId) graph.edges.push([bnId, eId]);
            });
            nodeIndex = new Map(graph.nodes.map((n, i) => [n.id, i]));
        }
        function buildAdj(re = new Set(), rn = new Set()) {
            const adj = Array(graph.nodes.length).fill(0).map(() => []);
            for (const [aiId, biId] of graph.edges) { const ai = nodeIndex.get(aiId), bi = nodeIndex.get(biId); if (ai == null || bi == null) continue; if (rn.has(ai) || rn.has(bi)) continue; if (re.has(`${ai}-${bi}`) || re.has(`${bi}-${ai}`)) continue; const w = hav(graph.nodes[ai], graph.nodes[bi]); adj[ai].push([bi, w]); adj[bi].push([ai, w]); }
            return adj;
        }
        function dijkstra(adj, src, dst) {
            const n = adj.length, dist = Array(n).fill(Infinity), prev = Array(n).fill(-1), used = Array(n).fill(false);
            dist[src] = 0; const pq = [{ d: 0, i: src }];
            const pop = () => { if (!pq.length) return null; let bi = -1, bd = Infinity; for (let i = 0; i < pq.length; i++)if (pq[i].d < bd) { bd = pq[i].d; bi = i; } return bi < 0 ? null : pq.splice(bi, 1)[0]; };
            while (pq.length) { const cur = pop(); if (!cur) break; const u = cur.i; if (used[u]) continue; used[u] = true; if (u === dst) break; for (const [v, w] of adj[u]) if (!used[v] && dist[u] + w < dist[v]) { dist[v] = dist[u] + w; prev[v] = u; pq.push({ d: dist[v], i: v }); } }
            const path = []; let u = dst; if (prev[u] === -1 && u !== src) return { path: [], distance: Infinity }; while (u !== -1) { path.push(u); if (u === src) break; u = prev[u]; } path.reverse(); return { path, distance: dist[dst] };
        }
        function pathDistance(idx) { let d = 0; for (let i = 0; i + 1 < idx.length; i++)d += hav(graph.nodes[idx[i]], graph.nodes[idx[i + 1]]); return d; }
        function arraysEqual(a, b) { if (a.length !== b.length) return false; for (let i = 0; i < a.length; i++)if (a[i] !== b[i]) return false; return true; }
        function yensKShortests(i, t, K) {
            const A = [], B = [], adj0 = buildAdj(), p0 = dijkstra(adj0, i, t);
            if (!p0.path.length || !isFinite(p0.distance)) return A; A.push(p0);
            for (let k = 1; k < K; k++) {
                const pp = A[k - 1].path;
                for (let iS = 0; iS < pp.length - 1; iS++) {
                    const sn = pp[iS], rp = pp.slice(0, iS + 1), re = new Set(), rn = new Set();
                    for (const p of A) { const cr = p.path.slice(0, iS + 1); if (arraysEqual(cr, rp) && p.path.length > iS + 1) { const u = p.path[iS], v = p.path[iS + 1]; re.add(`${u}-${v}`); re.add(`${v}-${u}`); } }
                    for (const r of rp.slice(0, -1)) rn.add(r);
                    const adj = buildAdj(re, rn), sr = dijkstra(adj, sn, t);
                    if (sr.path.length && isFinite(sr.distance)) { const tp = rp.slice(0, -1).concat(sr.path), td = pathDistance(tp); if (!B.some(b => arraysEqual(b.path, tp))) B.push({ path: tp, distance: td }); }
                }
                if (!B.length) break; B.sort((a, b) => a.distance - b.distance); A.push(B.shift());
                const uniq = []; for (const p of A) if (!uniq.some(q => arraysEqual(q.path, p.path))) uniq.push(p); uniq.sort((a, b) => a.distance - b.distance); A.splice(0, A.length, ...uniq);
            } return A;
        }

        function clearRoutes() {
            if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
            if (routeLayerGroup) { campusMap.removeLayer(routeLayerGroup); routeLayerGroup = null; }
            if (startMarker) { campusMap.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { campusMap.removeLayer(endMarker); endMarker = null; }
            stopArrowAnimation();
        }
        function setStartEndMarkers(A, B) {
            if (startMarker) { campusMap.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { campusMap.removeLayer(endMarker); endMarker = null; }
            startMarker = L.marker([A.lat, A.lng], { icon: createStartIcon(), zIndexOffset: 900 }).addTo(campusMap).bindPopup(`<strong>Start:</strong><br/>${A.name}`);
            endMarker = L.marker([B.lat, B.lng], { icon: createEndIcon(), zIndexOffset: 1000 }).addTo(campusMap).bindPopup(`<strong>Destination:</strong><br/>${B.name}`).openPopup();
        }

        // ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
        function checkDeviationAndRecalc(up) {
            if (!isNavigating || !currentDestination || !up || !currentPathIndices || !currentPathIndices.length) return false;
            let mn = Infinity;
            for (let i = 0; i < currentPathIndices.length; i++) { const d = hav(up, graph.nodes[currentPathIndices[i]]); if (d < mn) mn = d; }
            for (let i = 0; i < currentPathIndices.length - 1; i++) { const d = hav(up, nearestPointOnSegment(up, graph.nodes[currentPathIndices[i]], graph.nodes[currentPathIndices[i + 1]])); if (d < mn) mn = d; }
            if (mn > DEVIATION_THRESHOLD) { recalcRouteFromCurrent(); return true; } return false;
        }
        function recalcRouteFromCurrent() {
            if (!isNavigating || !userLatLng || !currentDestination) return;
            const up = { lat: userLatLng[0], lng: userLatLng[1] };
            let nnIdx = null, md = Infinity; graph.nodes.forEach((n, i) => { const d = hav(up, n); if (d < md) { md = d; nnIdx = i; } });
            if (nnIdx === null) return;
            const dId = nodeIndex.get(`ENT_${currentDestination.id}`); if (dId === undefined) return;
            const res = yensKShortests(nnIdx, dId, KROUTES); if (!res.length) return;
            lastResults = res; activeRouteIndex = 0;
            fullRoutePath = res[0].path.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);
            currentPathIndices = res[0].path.slice();
            setStartEndMarkers({ lat: userLatLng[0], lng: userLatLng[1], name: 'Your Location' }, currentDestination);
            renderDynamicRoute();
            if (isMobile()) updateMobileRouteInfo(pathDistance(currentPathIndices));
            else renderDesktopRouteStack(res, 0);
        }
        function updatePathBasedOnLocation() {
            if (!isNavigating || !userLatLng || !currentDestination || !currentPathIndices.length) return;
            const now = Date.now(); if (now - lastUpdateTime < UPDATE_THRESHOLD) return; lastUpdateTime = now;
            const up = { lat: userLatLng[0], lng: userLatLng[1] };
            if (checkDeviationAndRecalc(up)) return;
            let ci = 0, md = Infinity;
            for (let i = 0; i < currentPathIndices.length; i++) { const d = hav(up, graph.nodes[currentPathIndices[i]]); if (d < md) { md = d; ci = i; } }
            if (md < PROXIMITY_THRESHOLD && ci > 0) { currentPathIndices = currentPathIndices.slice(ci); renderDynamicRoute(); }
            if (isMobile()) updateMobileRouteInfo(pathDistance(currentPathIndices));
        }
        function renderDynamicRoute() {
            if (!isNavigating || !currentPathIndices.length) return;
            if (routeLayerGroup) { campusMap.removeLayer(routeLayerGroup); routeLayerGroup = null; }
            const ll = currentPathIndices.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);
            const border = L.polyline(ll, { color: '#ffffff', weight: 10, opacity: 0.9, lineCap: 'round', lineJoin: 'round', smoothFactor: 1.0 });
            const route = L.polyline(ll, { color: '#1967d2', weight: 6, opacity: 1, lineCap: 'round', lineJoin: 'round', smoothFactor: 1.0 });
            routeLayerGroup = L.layerGroup([border, route]).addTo(campusMap);
            startArrowAnimation(ll, arrowProgress);
        }

        function renderSelectedRoute(selectedIndex) {
            const results = lastResults; if (!results || !results.length) return;
            activeRouteIndex = selectedIndex; clearRoutes();
            const layers = [];
            results.forEach((res, idx) => {
                const ll = res.path.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);
                if (idx !== selectedIndex) {
                    const ab = L.polyline(ll, { color: '#ffffff', weight: 7, opacity: 0.8, lineCap: 'round', lineJoin: 'round', smoothFactor: 1.0 });
                    const al = L.polyline(ll, { color: '#8ab4f8', weight: 5.5, opacity: 0.7, lineCap: 'round', lineJoin: 'round', smoothFactor: 1.0 });
                    al.on('click', () => renderSelectedRoute(idx)); layers.push(ab, al);
                }
            });
            const sll = results[selectedIndex].path.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);
            const sb = animatedPolyline(sll, { color: '#ffffff', weight: 10, opacity: 0.9, lineCap: 'round', lineJoin: 'round', smoothFactor: 1.0 }, 1500);
            const pr = animatedPolyline(sll, { color: '#1967d2', weight: 6, opacity: 1, lineCap: 'round', lineJoin: 'round', smoothFactor: 1.0 }, 1500);
            layers.push(sb, pr); routeLayerGroup = L.layerGroup(layers).addTo(campusMap);
            setTimeout(() => startArrowAnimation(sll, 0), 1600);
            if (document.getElementById('fromBox').value === 'Current Location') { fullRoutePath = sll; currentPathIndices = results[selectedIndex].path.slice(); }
            const fv = document.getElementById('fromBox').value, tv = document.getElementById('toBox').value;
            let A, B;
            if (fv === 'Current Location' && userLatLng) A = { lat: userLatLng[0], lng: userLatLng[1], name: 'Your Location' }; else A = getLandmarkByNameOrId(fv);
            B = getLandmarkByNameOrId(tv);
            if (A && B) setStartEndMarkers(A, B);
            if (pr) setTimeout(() => campusMap.fitBounds(L.polyline(sll).getBounds().pad(0.2)), 100);
            const dist = results[selectedIndex].distance;
            if (isMobile()) updateMobileRouteInfo(dist);
            else renderDesktopRouteStack(results, selectedIndex);
        }

        function getLandmarkByNameOrId(name) {
            if (name === 'Current Location') return null;
            const lid = landmarkMapping[name]; if (lid) return places.find(p => p.id === lid);
            return places.find(p => p.name === name);
        }

        function searchRoute() {
            const fl = document.getElementById('fromBox').value, tl = document.getElementById('toBox').value;
            if (!fl || !tl) { alert('Please select both From and To locations'); return; }
            if (!campusMap) { initializeMap(); return; }
            startGeolocation();
            if (fl === 'Current Location') {
                if (!userLatLng) {
                    alert('Waiting for your location... Please allow location access.');
                    navigator.geolocation.getCurrentPosition(pos => { userLatLng = [pos.coords.latitude, pos.coords.longitude]; searchRoute(); }, () => alert('Could not get your current location.'));
                    return;
                }
                const B = getLandmarkByNameOrId(tl); if (!B) { alert('Invalid destination'); return; }
                isNavigating = true; currentDestination = B;
                const up = { lat: userLatLng[0], lng: userLatLng[1] };
                let nnId = null, md = Infinity; graph.nodes.forEach((n, i) => { const d = hav(up, n); if (d < md) { md = d; nnId = i; } });
                if (nnId === null) { alert('Could not connect to campus network'); isNavigating = false; return; }
                const dId = nodeIndex.get(`ENT_${B.id}`); if (dId === undefined) { alert('Cannot find destination'); isNavigating = false; return; }
                const res = yensKShortests(nnId, dId, KROUTES); if (!res.length) { alert('No path found'); isNavigating = false; return; }
                lastResults = res; activeRouteIndex = 0;
                setStartEndMarkers({ lat: userLatLng[0], lng: userLatLng[1], name: 'Your Location' }, B);
                renderSelectedRoute(0);
            } else {
                isNavigating = false; currentDestination = null;
                const A = getLandmarkByNameOrId(fl), B = getLandmarkByNameOrId(tl);
                if (!A || !B) { alert('Invalid location selected'); return; }
                const si = nodeIndex.get(`ENT_${A.id}`), ti = nodeIndex.get(`ENT_${B.id}`);
                if (si === undefined || ti === undefined) { alert('Cannot find entrance nodes'); return; }
                const res = yensKShortests(si, ti, KROUTES); if (!res.length) { alert('No path found'); return; }
                lastResults = res; activeRouteIndex = 0;
                setStartEndMarkers(A, B); renderSelectedRoute(0);
            }
        }

        function initializeLandmarkMarkers() {
            if (landmarkMarkersLayer) campusMap.removeLayer(landmarkMarkersLayer);
            landmarkMarkersLayer = L.layerGroup().addTo(campusMap);
            locationmarker.forEach(place => {
                const icon = L.divIcon({ className: 'custom-landmark-marker', html: `<div style="width:33px;height:33px;background:#e8f0fe;border:1.5px solid #1a73e8;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 2px 6px rgba(0,0,0,0.3);cursor:pointer;">${place.icon || 'üìç'}</div>`, iconSize: [33, 33], iconAnchor: [18, 18], popupAnchor: [0, -18] });
                const marker = L.marker([place.lat, place.lng], { icon, title: place.name });
                const pc = place.name === 'E Block' ? `<strong style="font-size:14px;"><a href="#" class="location-link" onclick="openSidebar();return false;">${place.name}</a></strong>` : `<strong style="font-size:14px;">${place.name}</strong>`;
                marker.bindPopup(pc).addTo(landmarkMarkersLayer);
            });
        }
        function toggleLandmarks() {
            if (!landmarkMarkersLayer) return;
            const btn = document.getElementById('landmarkToggleBtn');
            if (landmarksVisible) { campusMap.removeLayer(landmarkMarkersLayer); landmarksVisible = false; btn.classList.add('inactive'); }
            else { campusMap.addLayer(landmarkMarkersLayer); landmarksVisible = true; btn.classList.remove('inactive'); }
        }
        function startGeolocation() {
            if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
            if (userWatchId) navigator.geolocation.clearWatch(userWatchId);
            userWatchId = navigator.geolocation.watchPosition(geolocationSuccess, geolocationError, { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 });
        }
        function geolocationSuccess(pos) {
            const lat = pos.coords.latitude, lng = pos.coords.longitude, acc = pos.coords.accuracy;
            userLatLng = [lat, lng];
            if (userLocationMarker) campusMap.removeLayer(userLocationMarker);
            if (accuracyCircle) campusMap.removeLayer(accuracyCircle);
            userLocationMarker = L.circleMarker(userLatLng, { radius: 10, fillColor: '#4285F4', color: '#ffffff', weight: 3, opacity: 1, fillOpacity: 0.8, zIndexOffset: 1100 }).addTo(campusMap);
            accuracyCircle = L.circle(userLatLng, { radius: acc, fillColor: '#4285F4', color: '#4285F4', weight: 1, opacity: 0.3, fillOpacity: 0.1 }).addTo(campusMap);
            if (isNavigating) updatePathBasedOnLocation();
        }
        function geolocationError(err) { console.error('Geolocation error:', err); }
        function centerOnUserLocation() { if (userLatLng) campusMap.setView(userLatLng, 18); else startGeolocation(); }

        // ‚ïê‚ïê INIT ‚ïê‚ïê
        document.addEventListener('DOMContentLoaded', function () {
            const fl = document.getElementById('fromList'), tl = document.getElementById('toList');
            locationsList.forEach(loc => {
                let l1 = document.createElement('li'); l1.textContent = loc; fl.appendChild(l1);
                let l2 = document.createElement('li'); l2.textContent = loc; tl.appendChild(l2);
            });
            initializeMap(); setupSwapButton(); setupGlobalClickHandler(); setupSidebarHandlers();
            document.getElementById('currentLocationBtn')?.addEventListener('click', centerOnUserLocation);
            document.getElementById('landmarkToggleBtn')?.addEventListener('click', toggleLandmarks);
        });

        function setupSidebarHandlers() {
            const sm = document.getElementById('sideMenu'), ov = document.getElementById('overlay'), cb = document.getElementById('closeBtn');
            cb.addEventListener('click', e => { e.stopPropagation(); closeSidebar(); });
            ov.addEventListener('click', closeSidebar); sm.addEventListener('click', e => e.stopPropagation());
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && sm.classList.contains('open')) closeSidebar(); });
            let rt; window.addEventListener('resize', () => { clearTimeout(rt); rt = setTimeout(() => { if (window.innerWidth > 768 && sm.classList.contains('open')) closeSidebar(); }, 250); });
            document.querySelectorAll('.accordion-item').forEach(d => { d.addEventListener('toggle', function () { if (this.open) setTimeout(() => this.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 300); }); });
            let tsx = 0, tex = 0;
            sm.addEventListener('touchstart', e => { tsx = e.changedTouches[0].screenX; }, { passive: true });
            sm.addEventListener('touchend', e => { tex = e.changedTouches[0].screenX; if (tex - tsx > 50) closeSidebar(); }, { passive: true });
            sm.addEventListener('transitionend', () => { if (sm.classList.contains('open')) document.querySelectorAll('.accordion-item').forEach((item, i) => setTimeout(() => { item.style.animation = 'fadeIn 0.3s ease forwards'; }, i * 50)); });
        }
        window.openSidebar = openSidebar;
    </script>
</body>

</html>
